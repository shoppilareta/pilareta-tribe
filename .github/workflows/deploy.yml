name: Deploy to EC2

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e

            echo "=== Starting deployment ==="
            cd /var/www/pilareta-tribe

            # Pull latest code
            echo ">>> Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main

            # Load environment from server's .env.local (not overwritten by git)
            echo ">>> Loading environment variables..."
            if [ -f .env.local ]; then
              set -a
              source .env.local
              set +a
            else
              echo "ERROR: .env.local not found on server"
              exit 1
            fi

            # Install dependencies
            echo ">>> Installing dependencies..."
            pnpm install --frozen-lockfile --filter pilareta-tribe --filter @pilareta/shared || {
              echo ">>> Frozen lockfile failed, cleaning node_modules and retrying..."
              rm -rf node_modules
              pnpm install --no-frozen-lockfile --filter pilareta-tribe --filter @pilareta/shared
            }
            pnpm add -wD @types/google.maps 2>/dev/null || true

            # Generate Prisma client
            echo ">>> Generating Prisma client..."
            pnpm prisma generate

            # Sync database schema
            echo ">>> Syncing database schema..."
            pnpm prisma db push --skip-generate

            # Build the application
            echo ">>> Building application..."
            npx next build

            # Restart the application
            echo ">>> Restarting application..."
            if [ -f ecosystem.config.js ]; then
              pm2 restart ecosystem.config.js --update-env
            else
              pm2 restart pilareta-tribe --update-env || pm2 start npm --name "pilareta-tribe" -- start
            fi
            pm2 save

            echo "=== Deployment complete ==="

      - name: Health check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            # Wait for app to start
            sleep 5

            # Check if app is running
            pm2 status pilareta-tribe

            # Health check
            curl -s -o /dev/null -w "%{http_code}" http://localhost:3000 | grep -q "200" && echo "Health check passed!" || echo "Health check failed!"
